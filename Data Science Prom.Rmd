---
title: "Data Science Prom"
author: "Jundian"
date: "2025-08-14"
output: html_document
---

# Main
```{r}
# ---- 套件 ----
library(dplyr)
library(data.table)
library(ggplot2)
library(forcats)
library(nnet)
library(broom)
library(vcd)
library(reshape2)

# ---- 1. 讀取所有年度資料 ----
file_list <- list.files(pattern = "moi_people_house_dtl_simulation_\\d+\\.csv",
                        full.names = TRUE)

dt_list <- lapply(file_list, function(f){
  year <- gsub(".*_(\\d+)\\.csv", "\\1", f)   # 從檔名取年份
  df <- fread(f)
  df$year <- as.integer(year)
  return(df)
})
dt <- bind_rows(dt_list)

# ---- 2. 資料清理 ----
dt <- dt %>%
  mutate(
    materials_group_cd = factor(materials_group_cd,
                                levels=c("A","B","C","D"),
                                labels=c("鋼骨或金鋼筋混凝土","磚造","金屬造","其他")),
    purpose_group_cd = factor(purpose_group_cd,
                              levels=c("A","F","G","L","Q"),
                              labels=c("住家用","住商用","住工用","國民住宅","其他")),
    is_in_active_fault = ifelse(is_in_active_fault==1,1,0),
    is_in_dip_slope    = ifelse(is_in_dip_slope==1,1,0),
    is_in_lique_faction = factor(is_in_lique_faction)
  )

# ======================================================
# 每年卡方檢定
# ======================================================
cat("\n=== 每年卡方檢定 ===\n")
chi_results <- dt %>%
  group_by(year) %>%
  summarise(
    chi_fault_mat = list(chisq.test(table(materials_group_cd, is_in_active_fault))),
    chi_fault_pur = list(chisq.test(table(purpose_group_cd, is_in_active_fault))),
    chi_slope_mat = list(chisq.test(table(materials_group_cd, is_in_dip_slope))),
    chi_slope_pur = list(chisq.test(table(purpose_group_cd, is_in_dip_slope))),
    .groups = "drop"
  )
print(chi_results)

# ======================================================
# 每年 Logistic / Multinomial 回歸
# ======================================================
cat("\n=== 每年 Logistic 回歸 ===\n")
models_fault <- dt %>%
  group_by(year) %>%
  group_map(~ glm(is_in_active_fault ~ materials_group_cd + purpose_group_cd,
                  data = .x, family = binomial))

models_slope <- dt %>%
  group_by(year) %>%
  group_map(~ glm(is_in_dip_slope ~ materials_group_cd + purpose_group_cd,
                  data = .x, family = binomial))

models_lique <- dt %>%
  group_by(year) %>%
  group_map(~ multinom(is_in_lique_faction ~ materials_group_cd + purpose_group_cd, data = .x))
```

# 視覺化
```{r}
library(ggplot2)
library(dplyr)
library(scales)

# ---- 斷層帶 vs 建材 ----
ggplot(dt, aes(x=materials_group_cd,
               fill=factor(is_in_active_fault,
                           levels=c(0,1),
                           labels=c("未落在斷層帶","落在斷層帶")))) +
  geom_bar(position="fill") +
  scale_y_continuous(labels=percent) +
  labs(title="不同建材落在斷層帶的比例 (逐年比較)", x="主要建材", y="比例", fill="斷層帶") +
  facet_wrap(~ year) +
  theme_minimal()

# ---- 斷層帶 vs 用途 ----
ggplot(dt, aes(x=purpose_group_cd,
               fill=factor(is_in_active_fault,
                           levels=c(0,1),
                           labels=c("未落在斷層帶","落在斷層帶")))) +
  geom_bar(position="fill") +
  scale_y_continuous(labels=percent) +
  labs(title="不同用途落在斷層帶的比例 (逐年比較)", x="主要用途", y="比例", fill="斷層帶") +
  facet_wrap(~ year) +
  theme_minimal()

# ---- 土壤液化 vs 建材 ----
ggplot(dt, aes(x=materials_group_cd,
               fill=factor(is_in_lique_faction,
                           levels=c(0,1,2,3),
                           labels=c("非液化區","低潛勢液化區","中潛勢液化區","高潛勢液化區")))) +
  geom_bar(position="fill") +
  scale_y_continuous(labels=percent) +
  labs(title="不同建材落在土壤液化區的比例 (逐年比較)", x="主要建材", y="比例", fill="土壤液化") +
  facet_wrap(~ year) +
  theme_minimal()

# ---- 土壤液化 vs 用途 ----
ggplot(dt, aes(x=purpose_group_cd,
               fill=factor(is_in_lique_faction,
                           levels=c(0,1,2,3),
                           labels=c("非液化區","低潛勢液化區","中潛勢液化區","高潛勢液化區")))) +
  geom_bar(position="fill") +
  scale_y_continuous(labels=percent) +
  labs(title="不同用途落在土壤液化區的比例 (逐年比較)", x="主要用途", y="比例", fill="土壤液化") +
  facet_wrap(~ year) +
  theme_minimal()

# ---- 順逆向坡 vs 建材 ----
ggplot(dt, aes(x=materials_group_cd,
               fill=factor(is_in_dip_slope,
                           levels=c(0,1),
                           labels=c("未落在順逆向坡","落在順逆向坡")))) +
  geom_bar(position="fill") +
  scale_y_continuous(labels=percent) +
  labs(title="不同建材落在順逆向坡的比例 (逐年比較)", x="主要建材", y="比例", fill="順逆向坡") +
  facet_wrap(~ year) +
  theme_minimal()

# ---- 順逆向坡 vs 用途 ----
ggplot(dt, aes(x=purpose_group_cd,
               fill=factor(is_in_dip_slope,
                           levels=c(0,1),
                           labels=c("未落在順逆向坡","落在順逆向坡")))) +
  geom_bar(position="fill") +
  scale_y_continuous(labels=percent) +
  labs(title="不同用途落在順逆向坡的比例 (逐年比較)", x="主要用途", y="比例", fill="順逆向坡") +
  facet_wrap(~ year) +
  theme_minimal()


```




